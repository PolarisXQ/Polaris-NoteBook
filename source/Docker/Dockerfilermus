##########################################################################
FROM tb5zhh/icra-2023-client-base-carto:v2.0.0

# Add source codes into images and install dependencies
ADD src /opt/ep_ws/src/rmus_solution
WORKDIR /opt/ep_ws
RUN apt-key adv --keyserver keyserver.ubuntu.com --recv-key F6E65AC044F831AC80A06380C8B3A55A6F3EFCDE || apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv-key F6E65AC044F831AC80A06380C8B3A55A6F3EFCDE
RUN echo "deb https://librealsense.intel.com/Debian/apt-repo $(lsb_release -cs) main" > /etc/apt/sources.list.d/realsense.list
RUN apt-get update -q && \
     source /opt/workspace/devel_isolated/setup.bash && \
     ROS_OS_OVERRIDE=ubuntu:20.04:focal \
     DEBIAN_FRONTEND=noninteractive \        
     rosdep install -q --from-paths src --ignore-src --rosdistro noetic -y 
     # rm -rf /var/lib/apt/lists/* && \
     # apt-get clean

# Install extra dependencies with apt
RUN apt-get update && \
     apt-get install -y --no-install-recommends \
     # default
     wget \
     ros-noetic-depthimage-to-laserscan ros-noetic-map-server python3-tf-conversions ros-noetic-global-planner \
     # opengl
     libgles2-mesa-dev build-essential libgl1-mesa-dev freeglut3-dev libglew-dev libsdl2-dev libsdl2-image-dev libglm-dev libfreetype6-dev libglfw3-dev libglfw3 libao-dev libmpg123-dev \
     # pcl tools
     libpcl-dev pcl-tools \
     ros-noetic-cv-bridge ros-noetic-image-transport ros-noetic-image-transport-plugins ros-noetic-image-geometry ros-noetic-image-publisher ros-noetic-image-view \
     # ncnn
     build-essential git cmake libprotobuf-dev protobuf-compiler libvulkan-dev vulkan-utils libopencv-dev mesa-vulkan-drivers\
     # octomap
     liboctomap-dev octovis ros-noetic-octomap ros-noetic-octomap-mapping ros-noetic-octomap-msgs ros-noetic-octomap-ros ros-noetic-octomap-rviz-plugins  \
     # rqt
     ros-noetic-rqt ros-noetic-rqt-reconfigure ros-noetic-rqt-plot ros-noetic-rqt-common-plugins ros-noetic-rqt-tf-tree ros-noetic-tf-conversions 
     # rm -rf /var/lib/apt/lists/* && apt-get clean

# Install extra dependencies with pip
RUN pip3 install -i https://pypi.tuna.tsinghua.edu.cn/simple scipy

# Patch for keyboard
ADD ep_teleop /opt/ep_ws/src/ep_teleop

# Make client package
RUN source /opt/workspace/devel_isolated/setup.bash && catkin_make install --use-ninja -DSETUPTOOLS_DEB_LAYOUT=OFF
ENV ENV_ROBOT_MODE=sim

# Add start script
ADD start.sh /opt/start.sh
RUN echo "source /opt/ep_ws/devel/setup.bash" >> ~/.bashrc 
RUN echo "force_color_prompt=yes" >> ~/.bashrc
RUN source ~/.bashrc
CMD /opt/ros/noetic/env.sh /opt/ep_ws/devel/env.sh /bin/bash
